<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Persona Fingerprint Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background-color: #0056b3; }
        .button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .button.success { background-color: #28a745; }
        .button.danger { background-color: #dc3545; }
        .button.warning { background-color: #ffc107; color: #212529; }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .fingerprint-display {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }
        .fingerprint-image {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 10px 0;
        }
        .fingerprint-data {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }
        .fingerprint-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .info-card {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .info-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }
        .info-card .value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        .data-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin: 15px 0;
        }
        .data-tab {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .data-tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .data-content {
            display: none;
        }
        .data-content.active {
            display: block;
        }
        .download-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        .download-btn:hover {
            background-color: #218838;
        }
        .no-data {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1>üß™ Digital Persona Fingerprint Integration Test</h1>
    
    <div class="container">
        <h2>üì° Service Status</h2>
        <div id="serviceStatus" class="status info">Checking service status...</div>
        <button class="button" onclick="checkServiceHealth()">üîÑ Refresh Status</button>
    </div>

    <div class="grid">
        <div class="container">
            <h2>üîå Device Management</h2>
            <div class="form-group">
                <label for="deviceType">Device Type:</label>
                <select id="deviceType">
                    <option value="fingerprint_scanner">Fingerprint Scanner</option>
                </select>
            </div>
            <button class="button success" onclick="connectDevice()">üîó Connect Device</button>
            <button class="button danger" onclick="disconnectDevice()">‚ùå Disconnect Device</button>
            <button class="button" onclick="getDeviceStatus()">üìä Get Status</button>
            <button class="button" onclick="getSDKStatus()">üîß SDK Status</button>
        </div>

        <div class="container">
            <h2>üì∏ Single Fingerprint Capture</h2>
            <div class="form-group">
                <label for="fingerType">Finger Type:</label>
                <select id="fingerType">
                    <option value="LEFT_THUMB">Left Thumb</option>
                    <option value="LEFT_INDEX">Left Index</option>
                    <option value="LEFT_MIDDLE">Left Middle</option>
                    <option value="LEFT_RING">Left Ring</option>
                    <option value="LEFT_LITTLE">Left Little</option>
                    <option value="RIGHT_THUMB">Right Thumb</option>
                    <option value="RIGHT_INDEX">Right Index</option>
                    <option value="RIGHT_MIDDLE">Right Middle</option>
                    <option value="RIGHT_RING">Right Ring</option>
                    <option value="RIGHT_LITTLE">Right Little</option>
                </select>
            </div>
            <div class="form-group">
                <label for="qualityThreshold">Quality Threshold (0-100):</label>
                <input type="number" id="qualityThreshold" value="70" min="0" max="100">
            </div>
            <button class="button success" onclick="captureFingerprint()">üì∏ Capture Fingerprint</button>
        </div>
    </div>

    <div class="container full-width">
        <h2>üîÑ Batch Fingerprint Capture</h2>
        <div class="form-group">
            <label for="batchFingers">Select Fingers (Ctrl+Click for multiple):</label>
            <select id="batchFingers" multiple size="5">
                <option value="LEFT_THUMB">Left Thumb</option>
                <option value="LEFT_INDEX">Left Index</option>
                <option value="LEFT_MIDDLE">Left Middle</option>
                <option value="LEFT_RING">Left Ring</option>
                <option value="LEFT_LITTLE">Left Little</option>
                <option value="RIGHT_THUMB">Right Thumb</option>
                <option value="RIGHT_INDEX">Right Index</option>
                <option value="RIGHT_MIDDLE">Right Middle</option>
                <option value="RIGHT_RING">Right Ring</option>
                <option value="RIGHT_LITTLE">Right Little</option>
            </select>
        </div>
        <div class="form-group">
            <label for="batchQualityThreshold">Quality Threshold (0-100):</label>
            <input type="number" id="batchQualityThreshold" value="70" min="0" max="100">
        </div>
        <button class="button success" onclick="captureBatchFingerprints()">üì∏ Capture Batch</button>
        <button class="button warning" onclick="cancelCapture()">‚èπÔ∏è Cancel Capture</button>
    </div>

    <div class="container full-width">
        <h2>üñºÔ∏è Captured Fingerprint Display</h2>
        <div id="fingerprintDisplay" class="fingerprint-display">
            <div class="no-data">No fingerprints captured yet. Use the capture functions above to get started.</div>
        </div>
    </div>

    <div class="container full-width">
        <h2>üìä Results & Logs</h2>
        <div id="results" class="result">Ready to test fingerprint functionality...</div>
        <button class="button" onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <script>
        const API_BASE = '/fingerprint';
        let capturedFingerprints = [];
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            results.textContent += logEntry;
            results.scrollTop = results.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('serviceStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function displayFingerprint(fingerprint) {
            const display = document.getElementById('fingerprintDisplay');
            
            const hasImageData = fingerprint.imageData && fingerprint.imageData.length > 0;
            const hasWsqData = fingerprint.wsqData && fingerprint.wsqData.length > 0;
            
            let html = `
                <h3>üì∏ ${fingerprint.fingerType}</h3>
                <div class="fingerprint-info">
                    <div class="info-card">
                        <h4>Quality Score</h4>
                        <div class="value">${fingerprint.qualityScore || 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <h4>Capture Time</h4>
                        <div class="value">${fingerprint.captureTime || 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <h4>Image Data</h4>
                        <div class="value">${hasImageData ? 'Available' : 'None'}</div>
                    </div>
                    <div class="info-card">
                        <h4>WSQ Data</h4>
                        <div class="value">${hasWsqData ? 'Available' : 'None'}</div>
                    </div>
                </div>
            `;
            
            if (hasImageData) {
                html += `
                    <div class="data-tabs">
                        <div class="data-tab active" onclick="switchTab(this, 'image')">üñºÔ∏è Image View</div>
                        <div class="data-tab" onclick="switchTab(this, 'imageData')">üìÑ Image Data</div>
                        <div class="data-tab" onclick="switchTab(this, 'wsqData')">üîí WSQ Data</div>
                    </div>
                    
                    <div id="image" class="data-content active">
                        <img src="data:image/png;base64,${fingerprint.imageData}" alt="Fingerprint ${fingerprint.fingerType}" class="fingerprint-image">
                        <br>
                        <button class="download-btn" onclick="downloadImage('${fingerprint.imageData}', '${fingerprint.fingerType}_fingerprint.png')">üíæ Download PNG</button>
                    </div>
                    
                    <div id="imageData" class="data-content">
                        <div class="fingerprint-data">
                            <strong>Base64 Image Data (${fingerprint.imageData.length} characters):</strong><br><br>
                            ${fingerprint.imageData.substring(0, 200)}${fingerprint.imageData.length > 200 ? '...' : ''}
                        </div>
                        <button class="download-btn" onclick="downloadText('${fingerprint.imageData}', '${fingerprint.fingerType}_image_data.txt')">üíæ Download Data</button>
                    </div>
                    
                    <div id="wsqData" class="data-content">
                        <div class="fingerprint-data">
                            ${hasWsqData ? 
                                `<strong>WSQ Data (${fingerprint.wsqData.length} characters):</strong><br><br>
                                ${fingerprint.wsqData.substring(0, 200)}${fingerprint.wsqData.length > 200 ? '...' : ''}` :
                                '<em>No WSQ data available for this fingerprint</em>'
                            }
                        </div>
                        ${hasWsqData ? `<button class="download-btn" onclick="downloadText('${fingerprint.wsqData}', '${fingerprint.fingerType}_wsq_data.txt')">üíæ Download WSQ</button>` : ''}
                    </div>
                `;
            } else {
                html += `
                    <div class="no-data">
                        <p>‚ö†Ô∏è No image data available for this fingerprint</p>
                        <p>This might be due to capture failure or quality issues</p>
                    </div>
                `;
            }
            
            display.innerHTML = html;
        }

        function switchTab(clickedTab, tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.data-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.data-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            clickedTab.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function downloadImage(base64Data, filename) {
            const link = document.createElement('a');
            link.href = `data:image/png;base64,${base64Data}`;
            link.download = filename;
            link.click();
        }

        function downloadText(textData, filename) {
            const blob = new Blob([textData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function displayBatchResults(batchResponse) {
            const display = document.getElementById('fingerprintDisplay');
            
            if (batchResponse.capturedFingerprints.length === 0) {
                display.innerHTML = '<div class="no-data">No fingerprints were successfully captured in this batch.</div>';
                return;
            }
            
            let html = `
                <h3>üì∏ Batch Capture Results</h3>
                <div class="fingerprint-info">
                    <div class="info-card">
                        <h4>Total Captured</h4>
                        <div class="value">${batchResponse.capturedFingerprints.length}</div>
                    </div>
                    <div class="info-card">
                        <h4>Failed</h4>
                        <div class="value">${batchResponse.failedFingers.length}</div>
                    </div>
                    <div class="info-card">
                        <h4>Total Time</h4>
                        <div class="value">${batchResponse.totalTime || 'N/A'} ms</div>
                    </div>
                    <div class="info-card">
                        <h4>Quality Threshold</h4>
                        <div class="value">${batchResponse.qualityThreshold}</div>
                    </div>
                </div>
                
                <h4>üì∏ Captured Fingers:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 15px 0;">
            `;
            
            batchResponse.capturedFingerprints.forEach((fingerprint, index) => {
                const hasImageData = fingerprint.imageData && fingerprint.imageData.length > 0;
                html += `
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: white;">
                        <h5 style="margin: 0 0 10px 0; color: #495057;">${fingerprint.fingerType}</h5>
                        <div style="font-size: 12px; margin-bottom: 10px;">
                            Quality: ${fingerprint.qualityScore || 'N/A'} | 
                            Image: ${hasImageData ? 'Available' : 'None'} | 
                            WSQ: ${fingerprint.wsqData ? 'Available' : 'None'}
                        </div>
                        ${hasImageData ? 
                            `<img src="data:image/png;base64,${fingerprint.imageData}" alt="${fingerprint.fingerType}" style="max-width: 100%; height: auto; border-radius: 4px;">
                             <br><button class="download-btn" onclick="downloadImage('${fingerprint.imageData}', '${fingerprint.fingerType}_fingerprint.png')" style="margin-top: 5px;">üíæ Download</button>` :
                            '<div style="color: #6c757d; font-style: italic;">No image data</div>'
                        }
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (batchResponse.failedFingers.length > 0) {
                html += `
                    <h4>‚ùå Failed Fingers:</h4>
                    <div style="color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        ${batchResponse.failedFingers.map(finger => `<div>‚Ä¢ ${finger.fingerType}: ${finger.error || 'Unknown error'}</div>`).join('')}
                    </div>
                `;
            }
            
            display.innerHTML = html;
        }

        async function makeRequest(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function checkServiceHealth() {
            try {
                updateStatus('Checking service health...', 'info');
                const response = await makeRequest('/device/sdk-status');
                updateStatus(`‚úÖ Service Healthy - SDK: ${response}`, 'success');
                log(`‚úÖ Service health check successful: ${response}`);
            } catch (error) {
                updateStatus(`‚ùå Service Unavailable: ${error.message}`, 'error');
                log(`‚ùå Service health check failed: ${error.message}`);
            }
        }

        async function connectDevice() {
            try {
                const deviceType = document.getElementById('deviceType').value;
                log(`üîó Connecting to device: ${deviceType}`);
                
                const response = await makeRequest('/device/connect', 'POST', {
                    deviceType: deviceType,
                    autoConnect: true,
                    connectionTimeout: 10000
                });
                
                if (response.success) {
                    log(`‚úÖ Device connected successfully: ${response.deviceInfo?.deviceName || 'Unknown'}`);
                    updateStatus('‚úÖ Device Connected', 'success');
                } else {
                    log(`‚ùå Device connection failed: ${response.error}`);
                    updateStatus('‚ùå Device Connection Failed', 'error');
                }
            } catch (error) {
                log(`‚ùå Device connection error: ${error.message}`);
                updateStatus('‚ùå Connection Error', 'error');
            }
        }

        async function disconnectDevice() {
            try {
                log('‚ùå Disconnecting device...');
                const response = await makeRequest('/device/disconnect', 'POST');
                
                if (response.success) {
                    log('‚úÖ Device disconnected successfully');
                    updateStatus('‚ùå Device Disconnected', 'info');
                } else {
                    log('‚ùå Device disconnection failed');
                }
            } catch (error) {
                log(`‚ùå Device disconnection error: ${error.message}`);
            }
        }

        async function getDeviceStatus() {
            try {
                log('üìä Getting device status...');
                const response = await makeRequest('/device/status');
                
                log(`üìä Device Status:
    Connected: ${response.connected}
    Device Name: ${response.deviceName || 'N/A'}
    Device ID: ${response.deviceId || 'N/A'}
    Error: ${response.error || 'None'}`);
                
                if (response.connected) {
                    updateStatus('‚úÖ Device Connected', 'success');
                } else {
                    updateStatus('‚ùå Device Disconnected', 'info');
                }
            } catch (error) {
                log(`‚ùå Get device status error: ${error.message}`);
            }
        }

        async function getSDKStatus() {
            try {
                log('üîß Getting SDK status...');
                const response = await makeRequest('/device/sdk-status');
                log(`üîß SDK Status: ${response}`);
            } catch (error) {
                log(`‚ùå Get SDK status error: ${error.message}`);
            }
        }

        async function captureFingerprint() {
            try {
                const fingerType = document.getElementById('fingerType').value;
                const qualityThreshold = parseInt(document.getElementById('qualityThreshold').value);
                
                log(`üì∏ Capturing fingerprint: ${fingerType} (Quality: ${qualityThreshold})`);
                
                const response = await makeRequest('/capture', 'POST', {
                    fingerType: fingerType,
                    qualityThreshold: qualityThreshold,
                    captureTimeout: 30000,
                    retryCount: 3
                });
                
                if (response.success) {
                    log(`‚úÖ Fingerprint captured successfully:
    Finger Type: ${response.fingerType}
    Quality Score: ${response.qualityScore || 'N/A'}
    Image Data: ${response.imageData ? 'Available' : 'None'}
    WSQ Data: ${response.wsqData ? 'Available' : 'None'}
    Capture Time: ${response.captureTime || 'N/A'}`);
                    
                    // Store the captured fingerprint
                    capturedFingerprints = [response];
                    
                    // Display the fingerprint
                    displayFingerprint(response);
                    
                } else {
                    log(`‚ùå Fingerprint capture failed: ${response.error}`);
                }
            } catch (error) {
                log(`‚ùå Fingerprint capture error: ${error.message}`);
            }
        }

        async function captureBatchFingerprints() {
            try {
                const select = document.getElementById('batchFingers');
                const selectedFingers = Array.from(select.selectedOptions).map(option => option.value);
                const qualityThreshold = parseInt(document.getElementById('batchQualityThreshold').value);
                
                if (selectedFingers.length === 0) {
                    log('‚ùå Please select at least one finger for batch capture');
                    return;
                }
                
                log(`üì∏ Starting batch capture for: ${selectedFingers.join(', ')} (Quality: ${qualityThreshold})`);
                
                const response = await makeRequest('/capture/batch', 'POST', {
                    fingers: selectedFingers,
                    qualityThreshold: qualityThreshold,
                    captureTimeout: 60000,
                    retryCount: 2
                });
                
                if (response.success) {
                    log(`‚úÖ Batch capture completed:
    Captured Fingers: ${response.capturedFingers.length}
    Failed Fingers: ${response.failedFingers.length}
    Total Time: ${response.totalTime || 'N/A'}`);
                    
                    if (response.capturedFingers.length > 0) {
                        log('üì∏ Captured Fingers:');
                        response.capturedFingers.forEach(finger => {
                            log(`    - ${finger.fingerType}: Quality ${finger.qualityScore || 'N/A'}`);
                        });
                    }
                    
                    if (response.failedFingers.length > 0) {
                        log('‚ùå Failed Fingers:');
                        response.failedFingers.forEach(finger => {
                            log(`    - ${finger.fingerType}: ${finger.error}`);
                        });
                    }
                    
                    // Store the captured fingerprints
                    capturedFingerprints = response.capturedFingers;
                    
                    // Display the batch results
                    displayBatchResults(response);
                    
                } else {
                    log(`‚ùå Batch capture failed: ${response.error}`);
                }
            } catch (error) {
                log(`‚ùå Batch capture error: ${error.message}`);
            }
        }

        async function cancelCapture() {
            try {
                const fingerType = document.getElementById('fingerType').value;
                log(`‚èπÔ∏è Cancelling capture for: ${fingerType}`);
                
                const response = await makeRequest(`/capture/${fingerType}/cancel`, 'POST');
                
                if (response.success) {
                    log('‚úÖ Capture cancelled successfully');
                } else {
                    log('‚ùå Capture cancellation failed');
                }
            } catch (error) {
                log(`‚ùå Cancel capture error: ${error.message}`);
            }
        }

        function clearResults() {
            document.getElementById('results').textContent = 'Results cleared...\n';
            document.getElementById('fingerprintDisplay').innerHTML = '<div class="no-data">No fingerprints captured yet. Use the capture functions above to get started.</div>';
        }

        // Auto-check service health on page load
        window.addEventListener('load', () => {
            checkServiceHealth();
        });
    </script>
</body>
</html>
